import os
from yaml import load
from neural_network_config import NeuralNetworkConfig
from neo4j_config import Neo4JConfig
from joern_config import JoernConfig
from trainer_config import TrainerConfig
from tester_config import TesterConfig
from predictor_config import PredictorConfig

CONFIG_FILE = 'app_config.yml'


# App Config
class Config:
    def __init__(
            self,
            nn_config,
            neo4j_config,
            joern_config,
            trainer_config,
            tester_config,
            predictor_config
    ):
        self.nn_config = nn_config
        self.neo4j_config = neo4j_config
        self.joern_config = joern_config
        self.trainer_config = trainer_config
        self.tester_config = tester_config
        self.predictor_config = predictor_config


class ConfigLoader:
    def __init__(self):
        pass

    # load configurations form app_config
    @staticmethod
    def load():
        if os.path.exists(CONFIG_FILE):
            config_file = open(CONFIG_FILE, "r")

            try:
                # parse yml file to python dic
                yml_obj = load(config_file)

                # neural network configs
                nn_config = NeuralNetworkConfig(
                    input_size=yml_obj['nn_config']['input_size'],
                    label_class_size=yml_obj['nn_config']['label_class_size'],
                    iterations=yml_obj['nn_config']['iterations'],
                )

                # neo4j configs
                neo4j_config = Neo4JConfig(
                    server=yml_obj['neo4j_config']['server'],
                    username=yml_obj['neo4j_config']['username'],
                    password=yml_obj['neo4j_config']['password'],
                    config_location=yml_obj['neo4j_config']['config_location'],
                    data_location=yml_obj['neo4j_config']['data_location'],
                )

                # joern configs
                joern_config = JoernConfig(
                    installed_location=yml_obj['joern_config']['installed_location'],
                )

                # trainer configs
                trainer_config = TrainerConfig(
                    apps_location=yml_obj['trainer_config']['apps_location'],
                )

                # tester configs
                tester_config = TesterConfig(
                    apps_location=yml_obj['tester_config']['apps_location'],
                )

                # predictor configs
                predictor_config = PredictorConfig(
                    app_location=yml_obj['predictor_config']['app_location'],
                )

                config_file.close()
                return Config(nn_config, neo4j_config, joern_config, trainer_config, tester_config, predictor_config)
            
            except Exception as e:
                config_file.close()
                exit("Config file yml failed %r" % e)

        else:
            exit("Unable to load %s" % CONFIG_FILE)
