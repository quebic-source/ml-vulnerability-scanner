import time
from common_util import listdir, onehot_encode


class Trainer:

    def __init__(self, trainer_config, ctm, nn_model, label_class_size):
        self.trainer_config = trainer_config
        self.ctm = ctm
        self.nn_model = nn_model
        self.label_class_size = label_class_size

    def train(self):
        print "training start"
        start = time.time()

        try:
            x = []
            labels = []

            for lbl_class_dir in listdir(self.trainer_config.apps_location):

                # lbl_class_dir name. this will be 0, 1, 2
                lbl_index = int(lbl_class_dir[0])

                if lbl_index >= self.label_class_size:
                    print "found invalid lbl dir. lbl index should be less than label_class_size"
                    continue

                lbl_class_dir_path = lbl_class_dir[1]
                for app_dir in listdir(lbl_class_dir_path):
                    app_dir_path = app_dir[1]
                    code_matrix = self.ctm.convert(app_dir_path)
                    x.append(code_matrix)
                    labels.append(lbl_index)

            y = onehot_encode(labels, self.label_class_size)
            self.nn_model.train(x, y)
        except Exception as e:
            raise e

        print "time spent : ", (time.time() - start), " seconds"
        print "training completed"
